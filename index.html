<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
            body { font: 13px Helvetica, Arial;   }
            form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; }
            form input {  border: 0; padding: 10px; width: 90%; margin-right: 0.5%;  }
            form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
            #messages {  list-style-type: none; margin: 0; padding: 0; }
            #messages li { padding: 5px 10px; }
            #messages li:nth-child(odd) { background: #eee; }
    </style>
  </head>
  <body id="whoami" >
    <ul id="onlineusers"></ul>
    <ul id="messages"></ul>
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script>
        $(function(){
            let userList = [];
            //updates the user list html (done in multiple places)
            function updateUserList(){
              $('#onlineusers').html("");
                for(i in userList){
                  if(userList[i]=== whoami.attr("whoami")){
                    $('#onlineusers').append($('<li>').html("<b>" + userList[i] + " (You) </b>"));
                  } else{
                    $('#onlineusers').append($('<li>').text(userList[i]));
                  }
                }
            }
            var socket = io();
            let whoami = $("#whoami");
            whoami.attr("whoami","")
            $('form').submit(function(e){
                e.preventDefault(); //prevents page reloading
                let usermessage = {
                    userSend: whoami.attr("whoami"),
                    messageToDisplay: whoami.attr("whoami") + ": " + $('#m').val(),
                };
                socket.emit('chat message', usermessage);
                $('#m').val('');
                return false;
            });
            socket.on('chat message', function(msg){
              //checks if you were the one who sent the message, if so then bold it
                if(msg.userSend === whoami.attr("whoami")){
                  $('#messages').append($('<li>').html("<b>" + msg.messageToDisplay + "</b>"));
                } else{
                  $('#messages').append($('<li>').html(msg.messageToDisplay));
                }
            });
            //msg now is an object with userID and history
            socket.on('Joined',function(msg){
                console.log("joined " + msg.userID);
                if(whoami.attr("whoami") === ""){
                    whoami.attr("whoami",msg.userID);
                    for(i in msg.history){
                      $('#messages').append($('<li>').text(msg.history[i]));
                        console.log(msg.history[i]);
                  }
                }
                updateUserList();
                $('#messages').append($('<li>').text(msg.userID + " has joined"));
            });
            socket.on("updateUsers", function(msg){
              userList = msg;
              updateUserList();
            });
            //as the user disconnect
            $(window).bind('beforeunload', function(){
              socket.emit("removeUser",whoami.attr("whoami"));
            });
        });
    </script>
  </body>
</html>