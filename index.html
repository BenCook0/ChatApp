<!doctype html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <meta charset = "UTF-8">
    <style>
        * { margin: auto; padding: 0; box-sizing: border-box; max-width: 960px; }
            body { font: 13px Helvetica, Arial;  }
            form { background: #000; padding: 3px; position: fixed; bottom: 0; width: 100%; height: 5vh;}
            form input {  border: 0; padding: 10px; width: 90%; margin-right: 0.5%; }
            form button { width: 9%; background: rgb(130, 224, 255); border: none; padding: 10px; }
            ul {  list-style-type: none; margin: 0; padding: 0;
              height: 95vh; border: 3px solid black; overflow-y: scroll;
            display: inline-flexbox;}
            #messages li { padding: 5px 10px; overflow-wrap: break-word;;}
            #messages li:nth-child(odd) { background: #eee; }
            .row{
              display: flex;
              flex-direction: row;
              flex-wrap: wrap;
              width: 100%;
            }
            .column{
              display: flex;
              flex-direction: column;
              flex-basis: 100%;
              flex:1
            }
    </style>
  </head>
  <body id="whoami" >
    <div class = 'row'> 
      <div class = "column">
        <ul id="messages"></ul>
      </div>
      <div class = "column">
        <ul id="onlineusers"></ul>
      </div>
    </div>
    <form action="">
      <input id="m" autocomplete="off" /><button>Send</button>
    </form>
    <script src="/socket.io/socket.io.js"></script>
    <script src="http://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script>
        $(function(){
            let userList = [];
            //updates the user list html (done in multiple places)
            function updateUserList(){
              $('#onlineusers').html("");
                for(i in userList){
                  if(userList[i]=== whoami.attr("whoami")){
                    $('#onlineusers').append($('<li>').html("<b>" + replaceEmojis(userList[i]) + " (You) </b>"));
                  } else{
                    $('#onlineusers').append($('<li>').html(replaceEmojis(userList[i])));
                  }
                }
            }
            //replaces in text with emojis, called any time text is sent to the screen
            function replaceEmojis(toreplace){
                toreplace = toreplace.split(":)").join("&#128513");
                toreplace = toreplace.split(":(").join("&#128577");
                toreplace = toreplace.split(":o").join("&#128562");
                return(toreplace);
              }
            var socket = io();
            let whoami = $("#whoami");
            whoami.attr("whoami","")
            //on submit form
            $('form').submit(function(e){
                e.preventDefault(); //prevents page reloading
                messageText = $('#m').val();
                //if the message begins with /color then execute color change
                if(messageText.substring(0,7) === "/color "){
                  console.log("change the color my guy")
                }//if user types a /name 
                else if(messageText.substring(0,6) === "/name "){
                  //if this username is already taken
                  if(userList.includes(messageText.slice(6,messageText.length))){
                    $('#messages').append($('<li>').html("<i>" + "This username has already been taken" + "</i>"));
                  } else{
                    let usernamechange = {
                      oldname: whoami.attr("whoami"),
                      newname: messageText.slice(6,messageText.length)
                    }
                    whoami.attr("whoami",usernamechange.newname);
                    socket.emit("userNameChange", usernamechange);
                  }
                } else {
                  let usermessage = {
                    userSend: whoami.attr("whoami"),
                    messageToDisplay: whoami.attr("whoami") + ": " + messageText,
                  };
                  socket.emit('chat message', usermessage);
                }
                $('#m').val('');
                return false;
            });
            socket.on('chat message', function(msg){
              //checks if you were the one who sent the message, if so then bold it
                if(msg.userSend === whoami.attr("whoami")){
                  $('#messages').append($('<li>').html("<b>" + replaceEmojis(msg.messageToDisplay) + "</b>"));
                } else{
                  $('#messages').append($('<li>').html(replaceEmojis(msg.messageToDisplay)));
                }
                //scroll to the bottom on a chat message when received
                $("#messages").scrollTop($("#messages")[0].scrollHeight);

            });
            //msg now is an object with userID and history
            socket.on('Joined',function(msg){
                console.log("joined " + replaceEmojis(msg.userID));
                if(whoami.attr("whoami") === ""){
                    whoami.attr("whoami",msg.userID);
                    //send a messsage saying that X person has connected
                    let usermessage = {
                        userSend: whoami.attr("whoami"),
                        messageToDisplay: whoami.attr("whoami") + " has joined",
                  };
                    socket.emit('chat message', usermessage);
                    for(i in msg.history){
                      $('#messages').append($('<li>').html(replaceEmojis(msg.history[i])));
                  }
                }
                updateUserList();
            });
            socket.on("updateUsers", function(msg){
              userList = msg;
              updateUserList();
            });
            //as the user disconnect
            $(window).bind('beforeunload', function(){
              socket.emit("removeUser",whoami.attr("whoami"));
            });
        });
    </script>
  </body>
</html>